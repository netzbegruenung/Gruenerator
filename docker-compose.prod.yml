# Gruenerator Production Docker Compose
# Deployed via Salt to /opt/gruenerator/docker-compose.yml
#
# Usage:
#   TAG=latest docker compose -f docker-compose.prod.yml up -d
#
# Services:
#   - web: Static frontend (nginx serving Vite build)
#   - api: Backend API (Node.js, port 3001)
#   - docs: Documentation/collaboration service (Node.js, port 3003)
#   - mcp: MCP server for AI integrations (Node.js, port 3004)
#   - doku: Static Docusaurus documentation
#   - nginx: Internal reverse proxy

services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - gruenerator
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - 'com.gruenerator.service=redis'

  web:
    image: ghcr.io/netzbegruenung/gruenerator-web:${TAG:-latest}
    restart: unless-stopped
    networks:
      - gruenerator
    labels:
      - 'com.gruenerator.service=web'

  api:
    image: ghcr.io/netzbegruenung/gruenerator-api:${TAG:-latest}
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    env_file: .env
    environment:
      - PORT=3001
      - NODE_ENV=production
    volumes:
      - api-uploads:/app/apps/api/uploads
      - api-logs:/app/apps/api/logs
    networks:
      - gruenerator
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    labels:
      - 'com.gruenerator.service=api'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  docs:
    image: ghcr.io/netzbegruenung/gruenerator-docs:${TAG:-latest}
    restart: unless-stopped
    env_file: .env
    environment:
      - PORT=3000
      - NODE_ENV=production
    networks:
      - gruenerator
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    labels:
      - 'com.gruenerator.service=docs'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mcp:
    image: ghcr.io/netzbegruenung/gruenerator-mcp:${TAG:-latest}
    restart: unless-stopped
    env_file: .env
    environment:
      - PORT=3004
      - NODE_ENV=production
      - PUBLIC_URL=${MCP_PUBLIC_URL}
      - LOG_LEVEL=${MCP_LOG_LEVEL:-INFO}
    networks:
      - gruenerator
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    labels:
      - 'com.gruenerator.service=mcp'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3004/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  doku:
    image: ghcr.io/netzbegruenung/gruenerator-doku:${TAG:-latest}
    restart: unless-stopped
    networks:
      - gruenerator
    labels:
      - 'com.gruenerator.service=doku'

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - '127.0.0.1:8080:80'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      web:
        condition: service_started
      api:
        condition: service_healthy
      docs:
        condition: service_started
      mcp:
        condition: service_started
      doku:
        condition: service_started
    networks:
      - gruenerator
    labels:
      - 'com.gruenerator.service=nginx'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/nginx-health']
      interval: 30s
      timeout: 10s
      retries: 3

  # ComfyUI - Local GPU-based image generation (optional, requires NVIDIA GPU)
  # Start with: docker compose --profile gpu up -d comfyui
  comfyui:
    image: comfyanonymous/comfyui:latest
    restart: unless-stopped
    profiles:
      - gpu
    command: --listen 0.0.0.0 --port 8188 --disable-auto-launch
    volumes:
      - comfyui-models:/app/models
      - comfyui-output:/app/output
      - comfyui-input:/app/input
      - ./services/comfyui/workflows:/app/user/default/workflows:ro
    networks:
      - gruenerator
    labels:
      - 'com.gruenerator.service=comfyui'
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8188/system_stats']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  redis-data:
  api-uploads:
  api-logs:
  # ComfyUI volumes (only used when GPU profile is active)
  comfyui-models:
  comfyui-output:
  comfyui-input:

networks:
  gruenerator:
    driver: bridge
