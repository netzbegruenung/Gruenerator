name: Deploy to Test Environment

on:
  push:
    branches:
      - test-branch
  workflow_dispatch:

env:
  DEPLOY_HOST: gruenerator-test.netzbegruenung.verdigado.net
  DEPLOY_PATH: /opt/gruenerator

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test
    steps:
      - name: Deploy to Test Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e

            echo "=== Updating Salt configuration ==="
            sudo salt-call state.apply gruenerator-docker

            echo "=== Pulling latest images ==="
            cd ${{ env.DEPLOY_PATH }}
            docker compose pull

            echo "=== Deploying containers ==="
            docker compose up -d --force-recreate --remove-orphans

            echo "=== Waiting for health checks ==="
            sleep 10

            echo "=== Container status ==="
            docker compose ps

            echo "=== Health check ==="
            curl -sf http://localhost:8080/nginx-health || echo "Warning: nginx health check failed"

            echo "=== Cleanup old images ==="
            docker image prune -f

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "=== Running service checks ==="
            cd ${{ env.DEPLOY_PATH }}

            # Check all services are running
            RUNNING=$(docker compose ps --format json | jq -r 'select(.State == "running") | .Service' | wc -l)
            TOTAL=$(docker compose ps --format json | jq -r '.Service' | wc -l)

            echo "Running: $RUNNING / $TOTAL services"

            if [ "$RUNNING" -lt "$TOTAL" ]; then
              echo "ERROR: Not all services are running!"
              docker compose ps
              docker compose logs --tail=50
              exit 1
            fi

            echo "=== Deployment successful ==="

      - name: Notify on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "=== Deployment failed - gathering logs ==="
            cd ${{ env.DEPLOY_PATH }}
            docker compose logs --tail=100
