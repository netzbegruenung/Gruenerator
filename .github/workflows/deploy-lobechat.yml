name: Deploy LobeChat

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - update
          - restart
          - status

jobs:
  deploy-lobechat:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Validate Docker Compose config
        run: |
          docker compose -f services/lobechat/docker-compose.yml config --quiet
          echo "Docker Compose config is valid"

      - name: Copy config files to server
        if: github.event.inputs.action == 'deploy'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "services/lobechat/docker-compose.yml,services/lobechat/.env.example"
          target: "/opt/lobechat"
          strip_components: 2

      - name: Run deployment action
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            LOBECHAT_DIR="/opt/lobechat"

            case "${{ github.event.inputs.action }}" in
              deploy)
                echo "==> Full deployment of LobeChat"
                cd "$LOBECHAT_DIR"

                if [ ! -f .env ]; then
                  echo "ERROR: /opt/lobechat/.env not found."
                  echo "Create it from .env.example first:"
                  echo "  cp /opt/lobechat/.env.example /opt/lobechat/.env"
                  echo "  # Then fill in all secrets"
                  exit 1
                fi

                docker compose pull
                docker compose up -d --force-recreate
                echo "==> LobeChat deployed successfully"
                docker compose ps
                ;;

              update)
                echo "==> Updating LobeChat image"
                cd "$LOBECHAT_DIR"
                docker compose pull lobechat
                docker compose up -d lobechat
                echo "==> LobeChat updated"
                docker compose ps
                ;;

              restart)
                echo "==> Restarting LobeChat stack"
                cd "$LOBECHAT_DIR"
                docker compose restart
                echo "==> LobeChat restarted"
                docker compose ps
                ;;

              status)
                echo "==> LobeChat status"
                cd "$LOBECHAT_DIR"
                docker compose ps
                echo ""
                echo "==> Health check:"
                curl -sf http://127.0.0.1:3210/api/health && echo " OK" || echo " FAILED"
                ;;
            esac

      - name: Verify health
        if: github.event.inputs.action == 'deploy' || github.event.inputs.action == 'update'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Waiting for LobeChat to become healthy..."
            for i in $(seq 1 12); do
              if curl -sf http://127.0.0.1:3210/api/health > /dev/null 2>&1; then
                echo "LobeChat is healthy!"
                exit 0
              fi
              echo "Attempt $i/12 - waiting 10s..."
              sleep 10
            done
            echo "ERROR: LobeChat failed to become healthy within 120s"
            cd /opt/lobechat && docker compose logs --tail=50 lobechat
            exit 1
