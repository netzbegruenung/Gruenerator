name: Mirror Chat to Standalone Repo

on:
  push:
    branches: [master]
    paths:
      - 'packages/chat/**'
      - 'apps/chat/**'
      - 'packages/shared/src/auth/**'
      - '.github/workflows/mirror-chat.yml'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: monorepo

      - name: Checkout Chat standalone repo
        uses: actions/checkout@v4
        with:
          repository: Movm/Gruenerator-Chat
          token: ${{ secrets.MCP_REPO_PAT }}
          fetch-depth: 0
          path: chat-standalone

      - name: Sync files
        run: |
          # ================================================================
          # 1. Clean target (preserve .git, .github, LICENSE)
          # ================================================================
          find chat-standalone -mindepth 1 -maxdepth 1 \
            ! -name '.git' ! -name '.github' ! -name 'LICENSE' \
            -exec rm -rf {} +

          # ================================================================
          # 2. Copy packages/chat/src/ → src/chat/
          # ================================================================
          mkdir -p chat-standalone/src/chat
          cp -r monorepo/packages/chat/src/* chat-standalone/src/chat/

          # ================================================================
          # 3. Copy apps/chat/src/ → src/
          # ================================================================
          cp -r monorepo/apps/chat/src/* chat-standalone/src/

          # ================================================================
          # 4. Copy root-level config files from apps/chat
          # ================================================================
          cp -r monorepo/apps/chat/agents chat-standalone/
          cp -r monorepo/apps/chat/public chat-standalone/
          cp monorepo/apps/chat/.env.example chat-standalone/
          cp monorepo/apps/chat/.gitignore chat-standalone/
          cp monorepo/apps/chat/eslint.config.mjs chat-standalone/
          cp monorepo/apps/chat/postcss.config.mjs chat-standalone/
          cp monorepo/apps/chat/tailwind.config.ts chat-standalone/

          # ================================================================
          # 5. Copy shared auth components
          # ================================================================
          mkdir -p chat-standalone/src/components/auth/login-providers
          cp monorepo/packages/shared/src/auth/LoginProviders.tsx \
             chat-standalone/src/components/auth/login-providers/
          cp monorepo/packages/shared/src/auth/loginProviders.ts \
             chat-standalone/src/components/auth/login-providers/
          cp monorepo/packages/shared/src/auth/login-providers.css \
             chat-standalone/src/components/auth/login-providers/
          cp monorepo/packages/shared/src/auth/index.ts \
             chat-standalone/src/components/auth/login-providers/

          # ================================================================
          # 6. Rewrite imports
          # ================================================================
          cd chat-standalone

          # @gruenerator/chat/styles → @/chat/styles/chat.css (layout.tsx)
          sed -i "s|@gruenerator/chat/styles|@/chat/styles/chat.css|g" src/app/layout.tsx

          # @gruenerator/chat → @/chat (page.tsx, providers.tsx, chatAdapter.ts)
          sed -i "s|@gruenerator/chat|@/chat|g" src/app/page.tsx
          sed -i "s|@gruenerator/chat|@/chat|g" src/app/providers.tsx
          sed -i "s|@gruenerator/chat|@/chat|g" src/lib/chatAdapter.ts

          # @gruenerator/shared/auth → @/components/auth/login-providers (login/page.tsx)
          sed -i "s|@gruenerator/shared/auth|@/components/auth/login-providers|g" src/app/login/page.tsx

          # ================================================================
          # 7. Add CSS variable fallbacks to login-providers.css
          # ================================================================
          sed -i \
            -e 's/var(--spacing-medium)/var(--spacing-medium, 1rem)/g' \
            -e 's/var(--spacing-large)/var(--spacing-large, 1.5rem)/g' \
            -e 's/var(--spacing-small)/var(--spacing-small, 0.5rem)/g' \
            -e 's/var(--spacing-xxsmall)/var(--spacing-xxsmall, 0.25rem)/g' \
            -e 's/var(--background-color-alt)/var(--background-color-alt, #f8faf9)/g' \
            -e 's/var(--background-color)/var(--background-color, #ffffff)/g' \
            -e 's/var(--interactive-accent-color)/var(--interactive-accent-color, #46962b)/g' \
            -e 's/var(--primary-200)/var(--primary-200, #b3d9c6)/g' \
            -e 's/var(--secondary-200)/var(--secondary-200, #BACEC6)/g' \
            -e 's/var(--font-color-h)/var(--font-color-h, #1a1a1a)/g' \
            -e 's/var(--font-color)/var(--font-color, #1a1a1a)/g' \
            src/components/auth/login-providers/login-providers.css

          # ================================================================
          # 8. Generate standalone package.json
          # ================================================================
          cat > package.json << 'PKGJSON'
          {
            "name": "gruenerator-chat",
            "version": "1.0.0",
            "private": true,
            "license": "GPL-3.0-or-later",
            "scripts": {
              "dev": "next dev --port 3210",
              "build": "next build",
              "start": "next start --port 3210",
              "lint": "next lint",
              "typecheck": "tsc --noEmit"
            },
            "dependencies": {
              "@assistant-ui/react": "^0.9.3",
              "@assistant-ui/react-ai-sdk": "^0.9.3",
              "@assistant-ui/react-markdown": "^0.9.3",
              "@radix-ui/react-avatar": "^1.1.4",
              "@radix-ui/react-dialog": "^1.1.6",
              "@radix-ui/react-dropdown-menu": "^2.1.6",
              "@radix-ui/react-scroll-area": "^1.2.3",
              "@radix-ui/react-select": "^2.1.6",
              "@radix-ui/react-separator": "^1.1.2",
              "@radix-ui/react-slot": "^1.1.2",
              "@radix-ui/react-tabs": "^1.1.3",
              "@radix-ui/react-tooltip": "^1.1.8",
              "@ai-sdk/react": "^3.0.0",
              "@tanstack/react-query": "^5.77.0",
              "ai": "^6.0.0",
              "class-variance-authority": "^0.7.1",
              "clsx": "^2.1.1",
              "lucide-react": "^0.475.0",
              "next": "^15.3.0",
              "react": "^19.0.0",
              "react-dom": "^19.0.0",
              "react-markdown": "^9.0.3",
              "remark-gfm": "^4.0.0",
              "tailwind-merge": "^3.0.1",
              "zod": "^3.24.1",
              "zustand": "^5.0.3"
            },
            "devDependencies": {
              "@eslint/eslintrc": "^3.2.0",
              "@tailwindcss/postcss": "^4.1.18",
              "@tailwindcss/typography": "^0.5.16",
              "@types/node": "^22.15.0",
              "@types/react": "^19.0.0",
              "@types/react-dom": "^19.0.0",
              "eslint": "^9.20.0",
              "eslint-config-next": "^15.3.0",
              "postcss": "^8.5.3",
              "tailwindcss": "4",
              "typescript": "^5.7.3"
            }
          }
          PKGJSON

          # ================================================================
          # 9. Generate standalone next.config.ts
          # ================================================================
          cat > next.config.ts << 'NEXTCONFIG'
          import type { NextConfig } from 'next';

          const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

          const nextConfig: NextConfig = {
            output: 'standalone',
            experimental: {
              serverActions: {
                bodySizeLimit: '4mb',
              },
            },
            eslint: {
              ignoreDuringBuilds: true,
            },
            typescript: {
              ignoreBuildErrors: false,
            },
            images: {
              remotePatterns: [
                {
                  protocol: 'https',
                  hostname: '**',
                },
              ],
            },
            async rewrites() {
              return [
                {
                  source: '/api/:path*',
                  destination: `${API_URL}/api/:path*`,
                },
              ];
            },
          };

          export default nextConfig;
          NEXTCONFIG

          # ================================================================
          # 10. Generate standalone tsconfig.json
          # ================================================================
          cat > tsconfig.json << 'TSCONFIG'
          {
            "compilerOptions": {
              "target": "ES2022",
              "lib": ["dom", "dom.iterable", "esnext"],
              "allowJs": true,
              "skipLibCheck": true,
              "strict": true,
              "noEmit": true,
              "esModuleInterop": true,
              "module": "esnext",
              "moduleResolution": "bundler",
              "resolveJsonModule": true,
              "isolatedModules": true,
              "jsx": "preserve",
              "incremental": true,
              "plugins": [
                {
                  "name": "next"
                }
              ],
              "paths": {
                "@/*": ["./src/*"]
              }
            },
            "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
            "exclude": ["node_modules"]
          }
          TSCONFIG

          # ================================================================
          # 11. Generate standalone Dockerfile
          # ================================================================
          cat > Dockerfile << 'DOCKERFILE'
          # Gruenerator Chat — Standalone Dockerfile
          # Multi-stage build for Next.js standalone output

          # =============================================================================
          # Stage 1: Builder
          # =============================================================================
          FROM node:22-alpine AS builder

          WORKDIR /app

          COPY package.json package-lock.json* ./
          RUN if [ -f package-lock.json ]; then npm ci; else npm install; fi

          COPY . .

          ARG NEXT_PUBLIC_AUTH_DISABLED=false
          ENV NEXT_PUBLIC_AUTH_DISABLED=$NEXT_PUBLIC_AUTH_DISABLED
          ENV NEXT_TELEMETRY_DISABLED=1
          ENV NODE_ENV=production
          RUN npm run build

          # =============================================================================
          # Stage 2: Production
          # =============================================================================
          FROM node:22-alpine AS runner
          WORKDIR /app

          ENV NODE_ENV=production
          ENV NEXT_TELEMETRY_DISABLED=1

          RUN addgroup --system --gid 1001 nodejs
          RUN adduser --system --uid 1001 nextjs

          COPY --from=builder /app/public ./public
          COPY --from=builder /app/.next/standalone ./
          COPY --from=builder /app/.next/static ./.next/static
          COPY --from=builder /app/agents ./agents

          USER nextjs

          HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
              CMD node -e "require('http').get('http://localhost:3210/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"

          EXPOSE 3210

          ENV PORT=3210
          ENV HOSTNAME="0.0.0.0"

          CMD ["node", "server.js"]
          DOCKERFILE

          # ================================================================
          # 12. Generate .dockerignore
          # ================================================================
          cat > .dockerignore << 'DOCKERIGNORE'
          node_modules
          .next
          .git
          .github
          *.md
          !README.md
          .env
          .env.*
          !.env.example
          *.log
          .vscode
          .idea
          coverage
          .turbo
          DOCKERIGNORE

          # ================================================================
          # 13. Generate .coolify.yml
          # ================================================================
          cat > .coolify.yml << 'COOLIFY'
          # Coolify Configuration for Grünerator Chat
          # https://coolify.io/docs/knowledge-base/docker/compose-file

          services:
            chat:
              build:
                context: .
                dockerfile: Dockerfile
              ports:
                - '3210:3210'
              healthcheck:
                test:
                  [
                    'CMD',
                    'node',
                    '-e',
                    "require('http').get('http://localhost:3210/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
                  ]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
              restart: unless-stopped
              environment:
                - NODE_ENV=production
                - PORT=3210
                - HOSTNAME=0.0.0.0
                - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
                - MISTRAL_API_KEY=${MISTRAL_API_KEY}
                - MCP_URL=${MCP_URL}
                - DATABASE_URL=${DATABASE_URL}
                - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
                - NEXTAUTH_URL=${NEXTAUTH_URL}
                - NEXT_PUBLIC_AUTH_DISABLED=${NEXT_PUBLIC_AUTH_DISABLED:-false}

          labels:
            coolify.managed: 'true'
            coolify.name: 'gruenerator-chat'
            coolify.http.port: '3210'
          COOLIFY

          # ================================================================
          # 14. Generate README.md
          # ================================================================
          cat > README.md << 'README'
          # Grünerator Chat

          AI-powered chat interface for the German Green Party (Bündnis 90/Die Grünen).

          > **Note:** This repository is an automated mirror of the chat module from the
          > [Grünerator monorepo](https://github.com/netzbegruenung/gruenerator).
          > Please open issues and pull requests there.

          ## Features

          - Multi-agent AI chat with specialized assistants (speech writer, PR, citizen services, etc.)
          - Real-time streaming responses via AI SDK
          - Keycloak OIDC authentication with multiple identity providers
          - Dark/light theme support
          - File upload and attachment support
          - Chat history with sidebar navigation

          ## Getting Started

          ```bash
          # Install dependencies
          npm install

          # Copy and configure environment variables
          cp .env.example .env

          # Start development server
          npm run dev
          ```

          The app runs on [http://localhost:3210](http://localhost:3210).

          ## Docker

          ```bash
          docker build -t gruenerator-chat .
          docker run -p 3210:3210 --env-file .env gruenerator-chat
          ```

          ## Deploy with Coolify

          This repo includes a `.coolify.yml` and a Dockerfile with a built-in health check,
          so it works out of the box with [Coolify](https://coolify.io):

          1. Add this repository as a new resource in Coolify
          2. Coolify auto-detects the Dockerfile and builds the image
          3. Configure the required environment variables in the Coolify UI (see `.env.example`)
          4. Deploy — Coolify will wait for the health check at `/api/health` before marking the service as ready

          ## Environment Variables

          See [`.env.example`](.env.example) for all available configuration options.

          ## License

          This project is licensed under the [GNU General Public License v3.0](LICENSE).
          README

      - name: Check for changes
        id: changes
        run: |
          cd chat-standalone
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          cd chat-standalone
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get the commit message from monorepo
          COMMIT_MSG=$(cd ../monorepo && git log -1 --pretty=format:"%s")

          git commit -m "mirror: $COMMIT_MSG"
          git push
