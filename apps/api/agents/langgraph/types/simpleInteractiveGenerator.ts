/**
 * Type definitions for SimpleInteractiveGenerator
 * Defines interfaces for interactive question generation and session management
 */

import type { PromptAssemblyResult, Locale } from './promptAssembly.js';
import type { Request } from 'express';

/**
 * AI Worker Pool interface for processing AI requests
 */
export interface AIWorkerPool {
  processRequest(request: AIWorkerRequest, req?: Request): Promise<AIWorkerResponse>;
}

/**
 * Request to AI worker pool
 */
export interface AIWorkerRequest {
  /** Type of AI request */
  type: string;
  /** System prompt for the AI */
  systemPrompt: string;
  /** Conversation messages */
  messages: Array<{ role: string; content: string }>;
  /** Additional options for the AI request */
  options?: {
    max_tokens?: number;
    temperature?: number;
    tools?: ToolSchema[];
    [key: string]: unknown;
  };
}

/**
 * Response from AI worker pool
 */
export interface AIWorkerResponse {
  /** Whether the request was successful */
  success: boolean;
  /** Content returned from the AI */
  content?: string;
  /** Error message if failed */
  error?: string;
  /** Tool calls made by the AI */
  tool_calls?: ToolCall[];
  /** Usage statistics */
  metadata?: {
    usage?: {
      input_tokens?: number;
      output_tokens?: number;
      total_tokens?: number;
    };
  };
}

/**
 * Tool schema for AI function calling
 */
export interface ToolSchema {
  name: string;
  description: string;
  input_schema: Record<string, unknown>;
}

/**
 * Tool call from AI response
 */
export interface ToolCall {
  id?: string;
  name: string;
  input: string | Record<string, unknown>;
}

/**
 * Question generated by AI
 */
export interface GeneratedQuestion {
  id: string;
  text: string;
  type: string;
  uncertainty?: string;
  questionFormat: 'multiple_choice' | 'text' | 'number';
  options?: string[];
  optionEmojis?: string[];
  allowCustom?: boolean;
  allowMultiSelect?: boolean;
  skipOption?: string | boolean;
}

/**
 * AI question generation function arguments
 */
export interface QuestionGenerationArgs {
  needsClarification: boolean;
  confidenceReason?: string;
  questions?: Array<{
    id?: string;
    text: string;
    uncertainty?: string;
    options?: string[];
    emojis?: string[];
  }>;
}

/**
 * Result of question generation
 */
export interface QuestionGenerationResult {
  needsClarification: boolean;
  questions: GeneratedQuestion[];
  confidenceReason: string;
}

/**
 * Question defaults from config
 */
export interface QuestionDefaults {
  questionFormat?: 'multiple_choice' | 'text' | 'number';
  allowCustom?: boolean;
  allowMultiSelect?: boolean;
  skipOption?: string | boolean;
}

/**
 * Prompt configuration for question generation
 */
export interface QuestionPromptConfig {
  systemPrompt: string;
  generationPrompt: string;
  toolSchema: ToolSchema;
  questionDefaults?: QuestionDefaults;
  options?: {
    max_tokens?: number;
    temperature?: number;
    [key: string]: unknown;
  };
}

/**
 * State for generating clarifying questions
 */
export interface QuestionGenerationState {
  inhalt: string;
  requestType: string;
  generatorType: string;
  locale: string;
  aiWorkerPool: AIWorkerPool;
  req: Request;
}

/**
 * Answers to questions (question ID -> answer)
 */
export type QuestionAnswers = Record<string, string | string[]>;

/**
 * Structured answers extracted from Q&A
 */
export interface StructuredAnswers {
  scope: string[];
  audience: string | null;
  tone: string | null;
  facts: string[];
  structure: string | null;
  actionType: string | null;
  painPoint: string | null;
  beneficiaries: string[];
  budget: string | null;
  history: string | null;
  urgency: string | null;
}

/**
 * Web search result
 */
export interface WebSearchResult {
  results: Array<{
    title: string;
    url: string;
    content_snippets?: string;
    snippet?: string;
  }>;
  sources: Array<{
    title: string;
    url: string;
    snippet: string;
  }>;
}

/**
 * Web search service interface
 */
export interface SearxngService {
  performWebSearch(
    query: string,
    options: {
      maxResults?: number;
      language?: string;
    }
  ): Promise<{
    success: boolean;
    results?: Array<{
      title: string;
      url: string;
      content_snippets?: string;
      snippet?: string;
    }>;
  }>;
}

/**
 * Enrichment request for document processing
 */
export interface EnrichmentRequest {
  inhalt: string;
  requestType: string;
  userClarifications?: StructuredAnswers;
}

/**
 * Enriched context from request enrichment
 */
export interface EnrichedContext {
  documents?: Array<{
    title: string;
    content: string;
    source_url?: string;
    metadata?: Record<string, unknown>;
  }>;
  knowledge?: string[];
}

/**
 * Prompt context for assembly (compatible with PromptAssemblyState)
 */
export interface PromptContext {
  systemRole: string;
  request: {
    inhalt: string;
    requestType: string;
    locale: Locale;
  };
  documents: Array<{
    title: string;
    content: string;
    source_url?: string;
    metadata?: Record<string, unknown>;
  }>;
  knowledge: string[];
  locale: Locale;
}

/**
 * Re-export PromptAssemblyResult as AssembledPromptResult for clarity
 */
export type AssembledPromptResult = PromptAssemblyResult;

/**
 * Generation result
 */
export interface GenerationResult {
  content: string;
  metadata?: {
    usage?: {
      input_tokens?: number;
      output_tokens?: number;
      total_tokens?: number;
    };
  };
}

/**
 * Session data stored in Redis
 */
export interface InteractiveSession {
  sessionId: string;
  conversationState: 'questions_asked' | 'generating' | 'completed';
  inhalt: string;
  requestType: string;
  generatorType: string;
  locale: Locale;
  questionRound: number;
  questions: GeneratedQuestion[];
  answers: {
    round1?: QuestionAnswers;
  };
  finalResult?: string;
  metadata: {
    startTime: number;
    completedAt?: number;
    duration?: number;
    confidenceReason?: string;
  };
}

/**
 * Parameters for initiateInteractiveGenerator
 */
export interface InitiateGeneratorParams {
  userId: string;
  inhalt: string;
  requestType: string;
  generatorType?: string;
  locale?: Locale;
  aiWorkerPool: AIWorkerPool;
  req: Request;
}

/**
 * Result from initiateInteractiveGenerator
 */
export interface InitiateGeneratorResult {
  status: 'success' | 'completed' | 'error';
  sessionId: string;
  conversationState: 'questions_asked' | 'completed';
  questions?: GeneratedQuestion[];
  questionRound?: number;
  finalResult?: string;
  metadata?: {
    questionCount?: number;
    skippedQuestions?: boolean;
    confidenceReason?: string;
  };
  message?: string;
  error?: string;
}

/**
 * Parameters for continueInteractiveGenerator
 */
export interface ContinueGeneratorParams {
  userId: string;
  sessionId: string;
  answers: QuestionAnswers;
  aiWorkerPool: AIWorkerPool;
  req: Request;
}

/**
 * Result from continueInteractiveGenerator
 */
export interface ContinueGeneratorResult {
  status: 'completed' | 'error';
  sessionId: string;
  conversationState: 'completed';
  finalResult?: string;
  metadata?: {
    completedAt: number;
    duration: number;
  };
  message?: string;
  error?: string;
}

/**
 * Parameters for generateFinalResult
 */
export interface GenerateFinalResultParams {
  userId: string;
  sessionId: string;
  inhalt: string;
  requestType: string;
  generatorType?: string;
  locale?: Locale;
  questions?: GeneratedQuestion[];
  answers?: QuestionAnswers;
  aiWorkerPool: AIWorkerPool;
  req: Request;
}

/**
 * Generator prompt configuration
 */
export interface GeneratorConfig {
  systemRole: string;
  systemRoleExtensions?: Record<string, string>;
  systemRoleAppendix?: string;
  options?: {
    max_tokens?: number;
    temperature?: number;
    [key: string]: unknown;
  };
}
